{
  "id": "snapshot_1769610328000_g7ttwkb2p",
  "approvalId": "approval_1769587084304_n272ft8bu",
  "approvalTitle": "Structure Document - Sapphire (Revised)",
  "version": 3,
  "timestamp": "2026-01-28T14:25:28.000Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\nsapphire/\n├── src/\n│   ├── app/                          # Next.js App Router\n│   │   ├── (main)/                   # 認証必須ルート（レイアウト共有）\n│   │   │   ├── dashboard/            # ダッシュボード\n│   │   │   ├── sessions/             # セッション管理\n│   │   │   │   ├── active/           # アクティブセッション記録\n│   │   │   │   └── [id]/             # セッション詳細\n│   │   │   ├── players/              # 対戦相手管理\n│   │   │   │   └── [id]/             # プレイヤー詳細\n│   │   │   ├── currencies/           # 通貨管理\n│   │   │   │   └── [id]/             # 通貨詳細\n│   │   │   └── stores/               # 店舗管理\n│   │   ├── auth/                     # 認証ページ\n│   │   │   ├── signin/\n│   │   │   └── register/\n│   │   ├── api/                      # APIルート\n│   │   └── layout.tsx                # ルートレイアウト\n│   │\n│   ├── components/\n│   │   ├── layouts/                  # レイアウトコンポーネント\n│   │   │   ├── AppShell.tsx          # メインアプリシェル\n│   │   │   └── __fixtures__/         # React Cosmosフィクスチャ\n│   │   ├── ui/                       # 再利用可能UIコンポーネント\n│   │   ├── auth/                     # 認証関連コンポーネント\n│   │   ├── sessions/                 # セッション固有コンポーネント\n│   │   └── tournament/               # トーナメント関連コンポーネント\n│   │\n│   ├── server/\n│   │   ├── api/\n│   │   │   ├── routers/              # tRPCルーター（APIエンドポイント）\n│   │   │   │   ├── session.ts        # セッションCRUD\n│   │   │   │   ├── player.ts         # プレイヤー管理\n│   │   │   │   ├── sessionEvent.ts   # ライブイベント追跡\n│   │   │   │   ├── currency/         # 通貨関連\n│   │   │   │   ├── tournament/       # トーナメント関連\n│   │   │   │   └── ...\n│   │   │   ├── schemas/              # Zodバリデーションスキーマ\n│   │   │   ├── root.ts               # ルーター集約\n│   │   │   └── trpc.ts               # tRPC設定・ミドルウェア\n│   │   │\n│   │   ├── db/\n│   │   │   ├── schema/               # Drizzle ORMスキーマ\n│   │   │   │   ├── index.ts          # スキーマエクスポート・リレーション\n│   │   │   │   ├── user.ts\n│   │   │   │   ├── session.ts\n│   │   │   │   ├── player.ts\n│   │   │   │   ├── common.ts         # 共通スキーマユーティリティ\n│   │   │   │   └── ...\n│   │   │   ├── migrate.ts\n│   │   │   ├── seed.ts\n│   │   │   └── index.ts\n│   │   │\n│   │   └── auth/\n│   │       ├── index.ts\n│   │       ├── config.ts             # NextAuth設定\n│   │       └── edge-config.ts        # Edge互換設定\n│   │\n│   ├── trpc/\n│   │   ├── react.tsx                 # クライアントtRPCプロバイダー\n│   │   ├── server.tsx                # サーバーサイドtRPC呼び出し\n│   │   └── query-client.ts           # React Query設定\n│   │\n│   ├── contexts/                     # Reactコンテキスト\n│   │   └── PageTitleContext.tsx\n│   │\n│   ├── lib/                          # ユーティリティ\n│   │   ├── google-maps.ts\n│   │   └── version.ts\n│   │\n│   ├── styles/\n│   │   └── globals.css\n│   │\n│   └── middleware.ts                 # NextAuthミドルウェア\n│\n├── tests/\n│   ├── e2e/                          # Playwright E2Eテスト\n│   ├── integration/                  # 統合テスト\n│   ├── unit/                         # ユニットテスト\n│   ├── helpers/                      # テストユーティリティ\n│   └── setup.ts\n│\n├── drizzle/                          # DBマイグレーションファイル\n├── public/                           # 静的アセット\n└── .github/                          # GitHub Actions\n```\n\n## Naming Conventions\n\n### Files\n- **Components**: `PascalCase.tsx`（例: `SessionList.tsx`, `PlayerTagModal.tsx`）\n- **Pages/Routes**: `page.tsx`（Next.js App Router規約）\n- **Routers**: `camelCase.ts`（例: `session.ts`, `playerTag.ts`）\n- **Schemas**: `camelCase.ts`（例: `player.ts`, `tournament.ts`）\n- **Tests**: `[filename].test.ts`（例: `session.test.ts`）\n\n### Code\n- **Classes/Types**: `PascalCase`（例: `Session`, `Player`, `NewSession`）\n- **Functions/Methods**: `camelCase`（例: `createSession`, `getPlayerById`）\n- **Constants**: `UPPER_SNAKE_CASE` または `camelCase`（コンテキストによる）\n- **Variables**: `camelCase`（例: `userId`, `sessionData`）\n- **Database Tables**: `camelCase`（例: `pokerSessions`, `players`）\n- **tRPC Procedures**: `camelCase`（例: `list`, `create`, `update`, `delete`, `get`）\n\n## Import Patterns\n\n### Import Order\n1. React/Next.js関連\n2. 外部ライブラリ（Mantine, tRPC等）\n3. 内部モジュール（`@/`パス）\n4. 相対インポート\n5. スタイルインポート\n\n### Module/Package Organization\n```typescript\n// 絶対パスインポート（@/エイリアス使用）\nimport { api } from \"@/trpc/react\";\nimport { Button } from \"@mantine/core\";\n\n// サーバー/クライアント分離\nimport { createCaller } from \"@/server/api/root\";  // サーバーのみ\nimport { api } from \"@/trpc/react\";                 // クライアントのみ\n```\n\n## Code Structure Patterns\n\n### tRPCルーター構成\n```typescript\n// src/server/api/routers/[entity].ts\nexport const entityRouter = createTRPCRouter({\n  list: protectedProcedure\n    .input(listSchema)\n    .query(async ({ ctx, input }) => { ... }),\n\n  create: protectedProcedure\n    .input(createSchema)\n    .mutation(async ({ ctx, input }) => { ... }),\n\n  update: protectedProcedure\n    .input(updateSchema)\n    .mutation(async ({ ctx, input }) => { ... }),\n\n  delete: protectedProcedure\n    .input(deleteSchema)\n    .mutation(async ({ ctx, input }) => { ... }),\n});\n```\n\n### DBスキーマ構成\n```typescript\n// src/server/db/schema/[entity].ts\nimport { pgTable, text, timestamp } from \"drizzle-orm/pg-core\";\nimport { timestampColumns } from \"./common\";\n\nexport const entities = pgTable(\"entities\", {\n  id: text(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull(),\n  // ...フィールド定義\n  ...timestampColumns,\n});\n\n// 型エクスポート\nexport type Entity = typeof entities.$inferSelect;\nexport type NewEntity = typeof entities.$inferInsert;\n```\n\n### Reactコンポーネント構成\n```typescript\n// src/app/(main)/[feature]/[Feature]Content.tsx\n\"use client\";\n\nimport { ... } from \"@mantine/core\";\nimport { api } from \"@/trpc/react\";\n\nexport function FeatureContent() {\n  const { data, isLoading } = api.feature.list.useQuery();\n\n  if (isLoading) return <Loader />;\n\n  return (\n    <Container>\n      {/* コンテンツ */}\n    </Container>\n  );\n}\n```\n\n## Code Organization Principles\n\n1. **Single Responsibility**: 各ファイルは1つの明確な目的を持つ\n2. **Co-location**: コンポーネントはルート近くに配置（`SessionsContent.tsx`は`sessions/`内）\n3. **Separation of Concerns**:\n   - スキーマファイル（バリデーション）\n   - ルーターファイル（ビジネスロジック）\n   - コンポーネントファイル（UI）\n4. **Type Safety**: 全体で完全な型安全性を維持\n\n## Module Boundaries\n\n### レイヤー分離\n```\nUI Layer (src/app, src/components)\n  ├── Server Components: データフェッチ担当\n  ├── Client Components: データ表示・クエリ用データ作成担当\n  └── Server Actions: Mutation処理（順次移行予定）\n    ↓ tRPC calls / Server Actions\nAPI Layer (src/server/api/routers)\n    ↓ Drizzle queries\nData Layer (src/server/db/schema)\n    ↓ PostgreSQL\nDatabase\n```\n\n### UIレイヤーの責務分担\n- **Server Components**: データフェッチを担当。DBからデータを取得しクライアントに渡す\n- **Client Components**: データ表示とユーザーインタラクション。クエリ用パラメータの作成\n- **Server Actions**: Mutation処理（現在はtRPC mutation使用、順次Server Actionへ移行予定）\n\n### 依存関係の方向\n- UIレイヤー → APIレイヤー → データレイヤー（単方向）\n- スキーマ定義はルーターとUIの両方から参照可能\n- `src/server/db/schema/index.ts`でリレーションを一元管理（循環参照回避）\n\n### マルチテナント分離\n- 全クエリに`eq(table.userId, ctx.session.user.id)`を必須適用\n- ユーザー間のデータアクセスを完全に分離\n\n## Code Size Guidelines\n\n- **File size**: 500行以下を推奨（大規模ルーターは例外）\n- **Function size**: 50行以下を推奨\n- **Component size**: 200行以下を推奨（複雑なものは分割）\n- **Nesting depth**: 最大4レベル\n\n## Documentation Standards\n\n- 複雑なビジネスロジックにはインラインコメント\n- Zodスキーマによる自己文書化API\n- TypeScriptの型による暗黙的ドキュメンテーション\n- 主要な設計決定はコード内コメントで記録\n",
  "fileStats": {
    "size": 9912,
    "lines": 246,
    "lastModified": "2026-01-28T07:57:35.603Z"
  },
  "comments": []
}