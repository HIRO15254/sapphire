name: Version Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparing with main branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check version increment
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(jq -r '.version' package.json)
          echo "Current version: $CURRENT_VERSION"

          # Get base version to compare against
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs: compare with the target branch (main)
            git fetch origin main
            PREVIOUS_VERSION=$(git show origin/main:package.json 2>/dev/null | jq -r '.version' 2>/dev/null || echo "0.0.0")
            echo "Comparing with main branch"
          else
            # For push to main: compare with the parent commit
            PREVIOUS_VERSION=$(git show HEAD^:package.json 2>/dev/null | jq -r '.version' 2>/dev/null || echo "0.0.0")
            echo "Comparing with parent commit"
          fi
          echo "Previous version: $PREVIOUS_VERSION"

          # Compare versions using semver logic
          version_gt() {
            # Returns 0 (true) if $1 > $2
            local IFS=.
            local i ver1=($1) ver2=($2)
            for ((i=0; i<${#ver1[@]} || i<${#ver2[@]}; i++)); do
              local v1=${ver1[i]:-0}
              local v2=${ver2[i]:-0}
              if ((v1 > v2)); then
                return 0
              elif ((v1 < v2)); then
                return 1
              fi
            done
            return 1  # Equal versions
          }

          if [ "$CURRENT_VERSION" = "$PREVIOUS_VERSION" ]; then
            echo "::error::Version has not been incremented! Current: $CURRENT_VERSION, Previous: $PREVIOUS_VERSION"
            echo "Please update the version in package.json before merging to main."
            exit 1
          fi

          if version_gt "$CURRENT_VERSION" "$PREVIOUS_VERSION"; then
            echo "Version incremented: $PREVIOUS_VERSION -> $CURRENT_VERSION"
          else
            echo "::error::Version must be greater than previous! Current: $CURRENT_VERSION, Previous: $PREVIOUS_VERSION"
            exit 1
          fi

      - name: Generate version.json
        run: node scripts/generate-version.js

      - name: Display generated version info
        run: cat public/version.json
