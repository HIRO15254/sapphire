# 機能仕様書: ライブポーカーセッショントラッカー

**機能ブランチ**: `001-poker-session-tracker`
**作成日**: 2025-12-12
**ステータス**: ドラフト
**入力**: ユーザー説明: 日本のアミューズメントポーカー向けライブセッション・ハンド記録アプリケーション

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - 完了セッションの記録（アーカイブ記録）(優先度: P1)

ポーカープレイヤーとして、店舗を出た後に完了したセッションを素早く記録したい。プレイ中に記録する必要なく、結果を追跡できるようにするため。

**優先度の理由**: これがコアバリュー - プレイヤーは上達のために結果を追跡する必要がある。アーカイブ記録は、プレイ中に記録したくないユーザーに最小限の手間で即座に価値を提供する。

**独立テスト**: 店舗、ゲーム、時間範囲、バイイン、キャッシュアウトを含むセッション記録を作成することで完全にテスト可能。セッションの損益を即座に表示することで価値を提供。

**受け入れシナリオ**:

1. **前提** ログイン済み、**操作** 店舗、ゲーム、開始/終了時刻、バイイン、キャッシュアウトを入力して新規アーカイブセッションを作成、**結果** セッションが保存され、損益が計算・表示される
2. **前提** セッションを記録済み、**操作** セッション履歴を表示、**結果** すべてのセッションが日付順で結果とともに表示される
3. **前提** アーカイブセッション作成中、**操作** 店舗を選択、**結果** その店舗で利用可能なゲームのみ選択可能
4. **前提** アーカイブセッション作成中、**操作** バイイン/キャッシュアウト額を入力、**結果** 使用する通貨タイプの選択が必須
5. **前提** セッション記録中、**操作** 各オールインのポット額と勝率を追加、**結果** All-in EVが計算・表示される（各オールインのポット×勝率の合計）
6. **前提** オールイン記録のあるセッションを保有、**操作** セッションを表示、**結果** オールイン総数、総ポット額、平均勝率、計算されたAll-in EVが表示される

---

### ユーザーストーリー 2 - 仮想通貨の管理 (優先度: P1)

日本のアミューズメントポーカー店舗のプレイヤーとして、異なる仮想通貨の残高を追跡したい。各店舗の通貨保有量を把握し、ボーナスや購入を記録できるようにするため。

**優先度の理由**: 日本のアミューズメントポーカーは現金ではなく店舗固有の仮想通貨を使用する。通貨追跡なしでは、セッション結果を適切に記録・分析できない。

**独立テスト**: 通貨の作成、初期残高の設定、ボーナスと購入の記録で完全にテスト可能。すべての取引から計算された現在の保有量を表示することで価値を提供。

**受け入れシナリオ**:

1. **前提** ログイン済み、**操作** 名前と初期残高を付けて新規通貨を作成、**結果** 通貨が保存され、セッションやゲームで使用可能になる
2. **前提** 通貨を保有、**操作** 金額とソースを指定してボーナス受領を記録、**結果** ボーナスがログに記録され、残高計算に反映される
3. **前提** 通貨を保有、**操作** 金額と任意のメモを指定して購入を記録、**結果** 購入がログに記録され、残高計算に反映される
4. **前提** 複数の通貨を保有、**操作** 通貨一覧を表示、**結果** すべての通貨が現在の残高とともに表示される（計算式: 初期残高 + ボーナス + 購入 - セッションバイイン + セッションキャッシュアウト）
5. **前提** セッションのある通貨を保有、**操作** 通貨残高の内訳を表示、**結果** 各構成要素（初期、ボーナス、購入、セッション結果）が合計に寄与している様子が表示される

---

### ユーザーストーリー 3 - 店舗とゲームの管理 (優先度: P2)

プレイヤーとして、訪問するポーカー店舗とそこで提供されるゲームを登録したい。セッション記録時に選択でき、場所やゲームタイプ別のパフォーマンスを追跡できるようにするため。

**優先度の理由**: 店舗とゲームは意味のあるセッション追跡の前提条件。これらがないと、セッションデータは分析のためのコンテキストを欠く。

**独立テスト**: 店舗の作成、店舗へのゲーム追加、店舗詳細の表示で完全にテスト可能。店舗情報の整理により価値を提供。

**受け入れシナリオ**:

1. **前提** ログイン済み、**操作** 名前と任意の位置情報で店舗を作成、**結果** 店舗がアカウントに保存される
2. **前提** 店舗を保有、**操作** 通貨とレートを指定してキャッシュゲーム（NLHE）を追加、**結果** ゲームがその店舗に関連付けられる
3. **前提** 店舗を保有、**操作** バイイン、プライズストラクチャー、ブラインドストラクチャーを指定してトーナメント（NLHE）を追加、**結果** トーナメントがその店舗に関連付けられる
4. **前提** ゲームを持つ店舗を保有、**操作** 店舗を表示、**結果** 店舗詳細とそこで提供されるすべてのゲームが表示される

---

### ユーザーストーリー 4 - アクティブセッション記録 (優先度: P2)

本格的なプレイヤーとして、プレイ中にリアルタイムでセッションを記録したい。すべてのハンドをキャプチャし、セッション中のスタック推移を追跡できるようにするため。

**優先度の理由**: リアルタイム記録により、詳細なハンド分析とスタック追跡が可能になる。上達に真剣なプレイヤーにとって価値があるが、アーカイブ記録より手間がかかる。

**独立テスト**: アクティブセッションの開始、ハンドとスタック変動の記録、セッションの完了で完全にテスト可能。詳細なセッションタイムラインを提供することで価値を提供。

**受け入れシナリオ**:

1. **前提** ログイン済み、**操作** 店舗とゲームを指定してアクティブセッションを開始、**結果** 開始時刻付きでアクティブセッションが作成される
2. **前提** アクティブセッション中、**操作** ハンドを記録、**結果** ハンドがタイムスタンプ付きでセッションに保存される
3. **前提** アクティブセッション中、**操作** スタック額を更新、**結果** スタック履歴が更新される
4. **前提** アクティブセッション中、**操作** リバイまたはアドオンを記録、**結果** タイムスタンプと金額とともにログに記録される
5. **前提** アクティブセッション中、**操作** セッションを終了、**結果** 終了時刻とキャッシュアウトでセッションが確定される

---

### ユーザーストーリー 5 - テーブルのプレイヤーを追跡 (優先度: P3)

プレイヤーとして、同卓した対戦相手の情報を記録したい。将来のセッションで彼らのプレイスタイルについてのメモを参照できるようにするため。

**優先度の理由**: プレイヤー追跡はセッション記録の価値を高めるが、コアのセッション追跡機能の補助的なもの。

**独立テスト**: プレイヤープロファイルの作成、メモの追加、プレイヤー履歴の表示で完全にテスト可能。対戦相手データベースの構築により価値を提供。

**受け入れシナリオ**:

1. **前提** ログイン済み、**操作** 名前を指定してプレイヤーを作成、**結果** プレイヤーがアカウントに保存される
2. **前提** プレイヤーを保有、**操作** プレイヤーにタグを追加、**結果** タグがそのプレイヤーに関連付けられる
3. **前提** プレイヤーを保有、**操作** 特定の日付のメモを追加、**結果** メモが日付とともに保存される
4. **前提** アクティブセッション中、**操作** テーブルにプレイヤーを追加、**結果** そのプレイヤーがセッションに関連付けられる
5. **前提** セッション履歴のあるプレイヤーを保有、**操作** プレイヤーを表示、**結果** そのプレイヤーが参加したすべてのセッションが表示される

---

### ユーザーストーリー 6 - ハンド詳細の記録 (優先度: P3)

自分のプレイを分析するプレイヤーとして、カード、アクション、結果を含む詳細なハンド情報を記録したい。特定の状況をレビューして学習できるようにするため。

**優先度の理由**: ハンド記録は最も深いレベルの分析を提供するが、プレイ中にかなりの労力を要する。アクティブセッションを強化するが、基本的なセッション追跡には必須ではない。

**独立テスト**: ポジション、カード、ストリートごとのアクション、結果を含むハンドを記録することで完全にテスト可能。レビュー用のハンド履歴を作成することで価値を提供。

**受け入れシナリオ**:

1. **前提** アクティブセッション中、**操作** ホールカードとポジションを指定してハンドを記録、**結果** 基本情報付きでハンドが保存される
2. **前提** ハンド記録中、**操作** 各ストリート（プリフロップ/フロップ/ターン/リバー）のアクションを追加、**結果** アクションシーケンスが保存される
3. **前提** ハンド記録中、**操作** ハンドを注目ハンドとしてマーク、**結果** ハンドが後でレビューするためにフラグ付けされる
4. **前提** 他のプレイヤーが関与するハンドを記録中、**操作** そのプレイヤーのプロファイルにハンドをピン留め、**結果** ハンドがそのプレイヤーの注目ハンドに表示される

---

### ユーザーストーリー 7 - ユーザー認証とデータプライバシー (優先度: P1)

ユーザーとして、安全にログインし、データをプライベートに保ちたい。自分だけがポーカー記録にアクセスできるようにするため。

**優先度の理由**: 認証はマルチユーザーシステムとデータプライバシーの基盤。これなしでは、ユーザーはプライベートデータを持てない。

**独立テスト**: 登録、ログイン、アカウント間のデータ分離の確認で完全にテスト可能。

**受け入れシナリオ**:

1. **前提** 未登録、**操作** メールアドレスとパスワードでサインアップ、**結果** アカウントが作成され、ログイン状態になる
2. **前提** 未ログイン、**操作** Googleで認証、**結果** アカウントにログインされる
3. **前提** 未ログイン、**操作** Discordで認証、**結果** アカウントにログインされる
4. **前提** ログイン済み、**操作** アプリにアクセス、**結果** 自分のデータのみが表示される
5. **前提** ログイン済み、**操作** ログアウト、**結果** セッションが終了し、保護された機能にアクセスできなくなる

---

### ユーザーストーリー 8 - レスポンシブデザインとテーマサポート (優先度: P2)

ユーザーとして、モバイルとデスクトップの両方でアプリを使用し、ライト/ダークテーマをサポートしたい。どんな環境でも快適に使用できるようにするため。

**優先度の理由**: ユーザーは店舗でスマートフォンを使用してセッションを記録するため、モバイルの使いやすさが重要。テーマサポートは、暗いポーカールームでの目の疲れを軽減する。

**独立テスト**: 異なる画面サイズでアプリにアクセスし、テーマを切り替えることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** モバイルでアプリにアクセス、**操作** インターフェースをナビゲート、**結果** すべての機能が小さな画面でアクセス可能で使用可能
2. **前提** デスクトップでアプリにアクセス、**操作** インターフェースをナビゲート、**結果** レイアウトが利用可能なスペースを効果的に使用
3. **前提** アプリ内、**操作** テーマを切り替え、**結果** インターフェース全体がライト/ダークモード間で切り替わる
4. **前提** テーマ設定を行った、**操作** 後でアプリに戻る、**結果** 設定が記憶されている

---

### ユーザーストーリー 9 - PWAとオフライン機能 (優先度: P3)

プレイヤーとして、アプリをインストールして確実に動作させたい。店舗での接続が不安定でも使用できるようにするため。

**優先度の理由**: PWAインストールによりアクセスと体感パフォーマンスが向上する。一部の店舗ではネットワーク接続が不安定な場合がある。

**独立テスト**: PWAをインストールし、基本機能を確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** 対応ブラウザでアプリを表示、**操作** インストールを選択、**結果** アプリがPWAとしてインストールされる
2. **前提** アプリが更新された、**操作** アプリにアクセス、**結果** 更新が通知され、リフレッシュして新バージョンを取得可能
3. **前提** インストール済みPWAを使用、**操作** 起動、**結果** ブラウザのUIなしで開く

---

### エッジケース

- ユーザーが店舗を定義せずにセッションを作成しようとした場合は？システムは店舗の作成を促すか、店舗なしでのセッション作成を許可すべき。
- ユーザーが関連セッションを持つ店舗を削除した場合は？セッションは店舗名を保持しつつ「店舗削除済み」とマークし、履歴データを保存すべき。
- ユーザーが関連トランザクションを持つ通貨を削除した場合は？通貨は論理削除され、履歴参照を保持すべき。
- 複数デバイスからアクティブセッションを同時編集した場合は？タイムスタンプによる後勝ち；マルチデバイスアクセスについてユーザーに警告すべき。
- アクティブセッション記録中に接続が切れた場合は？ローカルの変更をキューに入れ、接続復旧時に同期すべき。
- ハンド記録が不完全（必須フィールドが欠落）な場合は？システムはドラフトとして保存を許可し、完成を促すべき。

## 要件 *(必須)*

### 機能要件

**認証 & ユーザー管理**
- **FR-001**: システムはメールアドレスとパスワードによるユーザー登録をサポートしなければならない
- **FR-002**: システムはGoogle OAuthによるソーシャルログインをサポートしなければならない
- **FR-003**: システムはDiscord OAuthによるソーシャルログインをサポートしなければならない
- **FR-004**: システムはユーザーデータを分離し、各ユーザーが自分の記録のみを見られるようにしなければならない
- **FR-005**: システムはユーザーがログアウトしてセッションをクリアできるようにしなければならない

**通貨管理**
- **FR-010**: システムはユーザーが初期残高付きで名前付き通貨を作成できるようにしなければならない
- **FR-011**: システムは現在残高を計算しなければならない: 初期残高 + ボーナス合計 + 購入合計 - セッションバイイン合計 + セッションキャッシュアウト合計
- **FR-012**: システムはユーザーが金額と任意のソース説明付きでボーナス受領を記録できるようにしなければならない
- **FR-013**: システムはユーザーが金額と任意のメモ付きで購入を記録できるようにしなければならない
- **FR-014**: システムは各構成要素（初期、ボーナス、購入、セッション結果）を示す残高内訳を表示しなければならない

**店舗管理**
- **FR-020**: システムはユーザーが名前付きで店舗を作成できるようにしなければならない
- **FR-021**: システムはユーザーが店舗の位置情報（緯度/経度または住所）を記録できるようにしなければならない
- **FR-021a**: システムはユーザーがカスタムGoogle Maps URLを店舗に設定できるようにしなければならない
- **FR-022**: システムはユーザーがリッチテキスト形式で店舗にメモを追加できるようにしなければならない
- **FR-023**: システムはゲームを特定の店舗に関連付けなければならない

**ゲーム管理**
- **FR-030**: システムは通貨とレート付きのキャッシュゲーム記録をサポートしなければならない（NLHEのみ）
- **FR-031**: システムは通貨、バイイン、プライズストラクチャー、ブラインドストラクチャー付きのトーナメント記録をサポートしなければならない（NLHEのみ）
- **FR-031a**: プライズストラクチャーは参加人数範囲（a-b人）に応じた順位範囲（c位-d位）ごとの払い出しを定義できなければならない。払い出しは以下の3種類から選択:
  - プール割合%: (バイイン-レーキ)の合計の何%が得られるか
  - 固定仮想通貨額: 具体的な仮想通貨の数値
  - カスタムプライズ: 具体的なプライズの文字列と、そのプライズの仮想通貨換算価値
- **FR-031b**: ブラインドストラクチャーはブレイク（休憩時間）を設定できなければならない
- **FR-032**: システムは各ゲームにリッチテキスト形式でメモを許可しなければならない

**セッション管理 - アーカイブ**
- **FR-040**: システムは店舗、ゲーム、開始時刻、終了時刻、バイイン、キャッシュアウト付きのアーカイブセッション作成を許可しなければならない
- **FR-040a**: システムは既存のアーカイブセッションの編集（店舗、ゲーム、時間、バイイン、キャッシュアウト、メモ）を許可しなければならない
- **FR-041**: システムは各セッションの損益を計算・表示しなければならない
- **FR-042**: システムはポット額、勝率（0-100%）、結果（勝ち/負け）を持つ個別のオールイン状況の記録を許可しなければならない。また「Run it X times」（複数回ランアウト）に対応し、ランアウト回数と勝利回数を記録できなければならない
- **FR-043**: システムはAll-in EVをセッション内のすべてのオールインの（ポット額×勝率）の合計として計算しなければならない
- **FR-044**: システムはセッション詳細にメイン収支とEV考慮収支を表示しなければならない。EV考慮収支は「実収支 - EV差分」として計算され、運要素を除いた実力ベースの収支を表す。オールイン記録テーブルには各オールインの実収支とEV差分を表示する
- **FR-045**: システムはリッチテキスト形式でセッションメモを許可しなければならない

**セッション管理 - アクティブ**
- **FR-050**: システムは店舗とゲームを指定してアクティブセッションの開始を許可しなければならない
- **FR-051**: システムはアクティブセッション中のテーブルにいるプレイヤーを追跡しなければならない
- **FR-052**: システムはアクティブセッション中のハンド記録を許可しなければならない
- **FR-053**: システムはアクティブセッション中のスタック推移を追跡しなければならない
- **FR-054**: システムはタイムスタンプ付きでリバイとアドオンの記録を許可しなければならない
- **FR-055**: システムはアクティブセッションを完了済みアーカイブセッションに変換できなければならない

**プレイヤー管理**
- **FR-060**: システムは名前付きでプレイヤープロファイルの作成を許可しなければならない
- **FR-061**: システムはユーザー定義タグでプレイヤーをタグ付けできるようにしなければならない
- **FR-062**: システムは各プレイヤーに日付指定のメモを許可しなければならない
- **FR-063**: システムは各プレイヤーにリッチテキスト形式で全般メモを許可しなければならない
- **FR-064**: システムはプレイヤーが遭遇した店舗/ゲームを追跡しなければならない
- **FR-065**: システムは特定のハンドをプレイヤープロファイルにピン留めできるようにしなければならない

**ハンド記録**
- **FR-070**: システムはアクティブセッション内でのハンド記録を許可しなければならない
- **FR-071**: システムはユーザーのホールカード記録をサポートしなければならない
- **FR-072**: システムはテーブルでのポジション記録をサポートしなければならない
- **FR-073**: システムはストリート別（プリフロップ、フロップ、ターン、リバー）のアクション記録をサポートしなければならない
- **FR-074**: システムはボードカード記録をサポートしなければならない
- **FR-075**: システムはハンドを注目ハンドとしてマークすることをサポートしなければならない
- **FR-076**: システムはリッチテキスト形式でハンドメモを許可しなければならない

**ユーザーインターフェース**
- **FR-080**: システムはモバイルとデスクトップ向けのレスポンシブデザインを提供しなければならない
- **FR-081**: システムはライト/ダークテーマをサポートしなければならない
- **FR-082**: システムはユーザーのテーマ設定を記憶しなければならない
- **FR-083**: システムはPWAとしてインストール可能でなければならない
- **FR-084**: システムは新バージョン用のキャッシュ更新メカニズムを提供しなければならない

**データ & コンテンツ**
- **FR-090**: システムはすべてのユーザーデータを永続的に保存しなければならない
- **FR-091**: システムは包括的なユーザーガイドドキュメントを含まなければならない

### 主要エンティティ

- **User（ユーザー）**: 登録ユーザーを表す；認証情報/ソーシャル認証リンクを持つ；他のすべてのエンティティを所有
- **Currency（通貨）**: 店舗の仮想通貨；名前、初期残高を持つ；残高はトランザクションから計算
- **BonusTransaction（ボーナストランザクション）**: 受け取ったボーナスの記録；金額、ソース、タイムスタンプを持つ；通貨に属する
- **PurchaseTransaction（購入トランザクション）**: 通貨購入の記録；金額、メモ、タイムスタンプを持つ；通貨に属する
- **Store（店舗）**: ポーカー店舗；名前、位置、メモを持つ；複数のゲームを含む
- **Game（ゲーム）**: キャッシュゲームまたはトーナメント（NLHEのみ）；通貨リンク、レート/バイインを持つ；店舗に属する
- **Session（セッション）**: プレイセッション（アーカイブまたはアクティブ）；店舗リンク、ゲームリンク、時間、バイイン、キャッシュアウト、メモを持つ；ハンドとオールイン記録を含む
- **AllInRecord（オールイン記録）**: 個別のオールイン状況；ポット額、勝率、結果（勝ち/負け）、Run it X times対応（ランアウト回数、勝利回数）を持つ；セッションに属する；All-in EVとEV考慮収支の計算に使用
- **Player（プレイヤー）**: 対戦相手プロファイル；名前、タグ、メモを持つ；セッションとハンドにリンク
- **PlayerTag（プレイヤータグ）**: ユーザー定義タグ；名前を持つ；複数のプレイヤーに割り当て可能
- **Hand（ハンド）**: 個別のハンド記録；カード、ポジション、アクション、ボード、メモを持つ；セッションに属する；プレイヤーにピン留め可能
- **StackUpdate（スタック更新）**: ある時点でのスタック額；アクティブセッションに属する
- **RebuyAddon（リバイ/アドオン）**: リバイまたはアドオンの記録；金額、タイムスタンプ、種類を持つ；アクティブセッションに属する

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは60秒以内にアーカイブセッションを記録できる
- **SC-002**: ユーザーは30秒以内にアクティブセッションを開始し、最初のハンドを記録できる
- **SC-003**: システムはパフォーマンス低下なく1,000人の同時ユーザーをサポートする
- **SC-004**: すべてのページが3Gモバイル接続で2秒以内にロードされる
- **SC-005**: 90%のユーザーが初回の試行で最初のセッション記録を正常に完了する
- **SC-006**: ユーザーはライト/ダークテーマを即座に（100ms以内）切り替えられる
- **SC-007**: PWAインストールがすべての対応ブラウザで正常に完了する
- **SC-008**: ユーザーはログイン後、任意のデバイスから自分のデータにアクセスできる
- **SC-009**: セッションの損益計算は100%正確である
- **SC-010**: すべてのユーザーガイドセクションが完成し、すべての機能をカバーしている

## 前提条件

- ユーザーはポーカー用語（ポジション、アクションなど）の基本的な知識を持っている
- 日本のアミューズメントポーカー店舗は現金ではなく仮想通貨を使用している
- ユーザーは店舗で断続的なインターネット接続を持つ（そのためPWAサポート）
- リッチテキストメモは保存とレンダリングにHTML形式を使用
- ゲームバリアントは初期リリースではNLHE（ノーリミットホールデム）のみに限定
- ブラインドストラクチャーは構造化データとして保存（ブラインド額と持続時間を持つレベル）
- プライズストラクチャーは構造化データとして保存（順位別の払い出し率または金額）
- 位置データは座標またはフリーテキストの住所のいずれか
- すべての日付/時刻はUTCで保存され、ユーザーのローカルタイムゾーンで表示される
- All-in EV計算: セッション内に記録された各オールインの（ポット額×勝率）の合計
- 通貨残高は正確性を確保するためトランザクションから常に計算される（直接保存されない）
