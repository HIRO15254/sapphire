# Feature Specification: ポーカーセッション記録機能の改善

**Feature Branch**: `003-session-enhancements`
**Created**: 2025-10-26
**Status**: Draft
**Input**: User description: "セッション記録機能に以下の改修を加えたいです。\n\n* セッション追加画面をモーダルに変更する\n* 場所を文字列ではなくDB上にエントリとして保存するようにする\n* メモをhtml形式で保存できるようにする（エディタにはmantineと連携できるtiptapを使用する）\n* セッションにタグを任意数設定できるようにし、フィルター機能でタグによるフィルターが行えるようにする"

## Clarifications

### Session 2025-10-26

- Q: 場所やタグを削除する際、それを参照している既存のセッションはどのように扱うべきですか？ → A: セッションから場所/タグの参照を削除するが、セッション自体は保持する（NULL化またはデフォルト値）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - モーダルでのセッション追加 (Priority: P1)

ユーザーはセッション一覧画面から離れることなく、モーダルウィンドウで新しいセッションを素早く記録できる。これにより、複数セッションを連続して記録する際の操作が効率化される。

**Why this priority**: 最も頻繁に使用される基本操作であり、ユーザー体験の向上に直結する。既存の別ページ遷移と比較して、作業フローが中断されないことで記録作業の継続性が保たれる。

**Independent Test**: セッション一覧画面で「新規追加」ボタンをクリックし、モーダルが開いてセッション情報を入力・保存できることで、単独で価値を提供できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがセッション一覧画面を表示している、**When** 「新規追加」ボタンをクリックする、**Then** モーダルウィンドウが開き、セッション入力フォームが表示される
2. **Given** モーダルでセッション情報を入力した、**When** 保存ボタンをクリックする、**Then** モーダルが閉じ、一覧画面に新しいセッションが表示される
3. **Given** モーダルが開いている、**When** キャンセルボタンまたは背景をクリックする、**Then** 入力内容が破棄され、モーダルが閉じる
4. **Given** モーダルでセッションを保存しようとした、**When** 必須項目が未入力の場合、**Then** エラーメッセージが表示され、モーダルは閉じない

---

### User Story 2 - 場所の管理と選択 (Priority: P2)

ユーザーは以前使用した場所を簡単に再選択でき、また新しい場所を追加できる。これにより、場所名の入力ミスがなくなり、データの一貫性が向上する。

**Why this priority**: 複数回同じ場所でプレイするユーザーにとって、入力の手間を大幅に削減できる。また、統計分析時に場所ごとの集計精度が向上する。

**Independent Test**: セッション追加モーダルで場所の選択ドロップダウンが表示され、既存の場所を選択または新規場所を追加してセッションを保存できることで、単独で価値を提供できる。

**Acceptance Scenarios**:

1. **Given** セッション追加モーダルを開いた、**When** 場所入力欄をクリックする、**Then** 過去に使用した場所のリストが表示される
2. **Given** 場所リストを表示している、**When** リストにない新しい場所名を入力する、**Then** 「新規追加: [場所名]」オプションが表示される
3. **Given** 新規場所を入力した、**When** セッションを保存する、**Then** 場所がデータベースに登録され、次回以降選択可能になる
4. **Given** 場所リストを表示している、**When** 場所名の一部を入力する、**Then** リストがフィルタリングされて一致する場所のみが表示される

---

### User Story 3 - リッチテキストメモの記録 (Priority: P3)

ユーザーはセッション中の重要な出来事や戦略を、太字・リスト・見出しなどの書式を使って詳細に記録できる。これにより、後で振り返る際に情報が整理されて読みやすくなる。

**Why this priority**: メモ機能の価値を大幅に向上させるが、基本的なセッション記録機能には必須ではない。プレイの改善に真剣なユーザーにとって重要な機能。

**Independent Test**: セッション追加・編集モーダルでリッチテキストエディタが表示され、書式設定を含むメモを保存・表示できることで、単独で価値を提供できる。

**Acceptance Scenarios**:

1. **Given** セッション追加/編集モーダルを開いた、**When** メモ入力欄をクリックする、**Then** リッチテキストエディタのツールバー（太字、イタリック、リスト等）が表示される
2. **Given** メモを入力している、**When** テキストを選択してツールバーの「太字」をクリックする、**Then** 選択テキストが太字で表示される
3. **Given** 書式設定を含むメモを入力した、**When** セッションを保存する、**Then** メモがHTML形式でデータベースに保存される
4. **Given** HTML形式のメモが保存されている、**When** セッション詳細を表示する、**Then** 書式が保持されたメモが表示される

---

### User Story 4 - タグによる分類とフィルタリング (Priority: P4)

ユーザーはセッションに複数のタグ（例：トーナメント、キャッシュゲーム、深夜、好調等）を設定し、後でタグでフィルタリングして特定の条件のセッションを分析できる。

**Why this priority**: データ分析の柔軟性を大幅に向上させるが、基本的な記録・閲覧機能には必須ではない。上級ユーザーや長期間使用するユーザーにとって価値が高い。

**Independent Test**: セッション追加・編集モーダルでタグを追加でき、セッション一覧画面でタグによるフィルターが機能することで、単独で価値を提供できる。

**Acceptance Scenarios**:

1. **Given** セッション追加/編集モーダルを開いた、**When** タグ入力欄に新しいタグ名を入力してEnterキーを押す、**Then** タグが追加され、入力欄はクリアされる
2. **Given** タグを複数追加した、**When** タグの削除アイコンをクリックする、**Then** 該当タグが削除される
3. **Given** セッション一覧画面を表示している、**When** タグフィルターで特定のタグを選択する、**Then** そのタグが設定されているセッションのみが表示される
4. **Given** タグフィルターで複数のタグを選択した、**When** フィルターを適用する、**Then** 選択したすべてのタグを持つセッションのみが表示される（AND条件）
5. **Given** タグ入力欄に新しいタグを入力している、**When** 既存のタグ名の一部を入力する、**Then** オートコンプリート候補として既存タグが表示される

---

### Edge Cases

- モーダルを開いた状態で、大量のデータが一覧画面に読み込まれている場合でも、パフォーマンスが低下しないか？
- 場所名に特殊文字（絵文字、記号等）が含まれる場合、正しく保存・表示されるか？
- リッチテキストエディタで非常に長いメモ（10,000文字以上）を入力した場合、保存・表示に問題ないか？
- HTML形式のメモにスクリプトタグや危険なコンテンツが含まれる場合、XSS攻撃を防げるか？
- タグ名に重複がある場合（大文字小文字の違いのみ等）、どのように処理されるか？
- セッションに50個以上のタグを設定しようとした場合、制限があるか？
- 複数のタグで同時にフィルタリングした際に、該当セッションが0件の場合、適切なメッセージが表示されるか？
- モーダル内でフォーム送信中にネットワークエラーが発生した場合、入力内容は保持されるか？
- 多数のセッションで使用されている場所やタグを削除する場合、大量のセッション更新によるパフォーマンス問題が発生しないか？
- 削除された場所を参照しているセッションを表示する際、ユーザーに適切な情報（例：「削除された場所」）が表示されるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、セッション一覧画面からモーダルウィンドウでセッション追加フォームを表示できなければならない
- **FR-002**: システムは、モーダルウィンドウ内でセッション情報（日時、場所、バイイン、キャッシュアウト、プレイ時間、メモ、タグ）を入力・編集できなければならない
- **FR-003**: システムは、モーダルのキャンセルまたは背景クリックで、未保存の変更を破棄してモーダルを閉じることができなければならない
- **FR-004**: システムは、場所情報を独立したデータベースエントリとして管理し、重複を防ぐ必要がある
- **FR-005**: システムは、セッション追加・編集時に、既存の場所を選択可能なドロップダウンリストで表示しなければならない
- **FR-006**: システムは、ドロップダウンリストにない新しい場所を入力・追加できなければならない
- **FR-007**: システムは、場所のオートコンプリート機能（部分一致検索）を提供しなければならない
- **FR-008**: システムは、メモをHTML形式でデータベースに保存しなければならない
- **FR-009**: システムは、メモ入力時にリッチテキストエディタ（太字、イタリック、見出し、リスト等の基本的な書式設定）を提供しなければならない
- **FR-010**: システムは、保存されたHTML形式のメモを書式を保持して表示しなければならない
- **FR-011**: システムは、メモのHTMLコンテンツをサニタイズして、XSS攻撃を防がなければならない
- **FR-012**: ユーザーは、1つのセッションに対して複数のタグを任意数追加できなければならない
- **FR-013**: システムは、タグを独立したデータベースエントリとして管理し、セッションとの多対多関係を保持しなければならない
- **FR-014**: システムは、タグ入力時に既存タグのオートコンプリート候補を表示しなければならない
- **FR-015**: システムは、セッション一覧画面でタグによるフィルタリング機能を提供しなければならない
- **FR-016**: システムは、複数タグによる AND 条件フィルタリング（すべてのタグを含むセッションのみ表示）をサポートしなければならない
- **FR-017**: システムは、タグ名の大文字小文字を区別せず、重複タグの作成を防がなければならない
- **FR-018**: システムは、既存セッションの編集もモーダルウィンドウで行えなければならない
- **FR-019**: システムは、モーダル内のフォームバリデーションエラーを表示し、モーダルを閉じずにユーザーが修正できるようにしなければならない
- **FR-020**: 場所を削除する場合、システムはその場所を参照しているセッションの場所をデフォルト値（「削除された場所」等）に置き換えなければならない。セッション自体は保持される
- **FR-021**: タグを削除する場合、システムはそのタグとセッションの関連付けを削除しなければならない。セッション自体は保持される

### Key Entities

- **場所 (Location)**: ポーカーをプレイする物理的または仮想的な場所を表す。主要属性として、一意の場所名と作成日時を含む。複数のセッションで再利用される。

- **タグ (Tag)**: セッションを分類するためのラベル。主要属性として、一意のタグ名（大文字小文字区別なし）と作成日時を含む。複数のセッションと多対多の関係を持つ。

- **セッション (Session)**: 既存のセッションエンティティが拡張され、場所への参照（外部キー）、HTML形式のメモフィールド、およびタグとの多対多関係を含む。

- **セッション-タグ関連 (Session-Tag Relationship)**: セッションとタグの多対多関係を管理する中間エンティティ。セッションIDとタグIDの組み合わせを保持する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは、セッション一覧画面からページ遷移することなく、モーダルで新しいセッションを60秒以内に記録できる
- **SC-002**: ユーザーは、同じ場所で10回目のセッションを記録する際、場所名の入力にかかる時間が最初のセッションと比較して80%削減される（選択のみで完了）
- **SC-003**: ユーザーは、リッチテキストエディタで少なくとも5種類の書式設定（太字、イタリック、見出し、リスト、リンク）を使用してメモを記録できる
- **SC-004**: 保存されたリッチテキストメモは、すべての書式が保持された状態で表示され、ユーザーの100%が書式崩れを報告しない
- **SC-005**: ユーザーは、タグフィルターを使用して、1000セッションの中から特定条件のセッションを1秒以内に絞り込める
- **SC-006**: システムは、タグのオートコンプリート候補を300ミリ秒以内に表示する
- **SC-007**: モーダルの開閉操作は200ミリ秒以内に完了し、ユーザーに遅延を感じさせない
- **SC-008**: 場所とタグの重複防止機能により、データの不整合が発生しない（重複率0%）
- **SC-009**: HTML メモのサニタイゼーション機能により、XSS攻撃の成功率が0%になる
- **SC-010**: ユーザーの90%以上が、モーダル化により「複数セッションの連続記録が楽になった」と評価する
